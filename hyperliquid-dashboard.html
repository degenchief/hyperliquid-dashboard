<!DOCTYPE html>
<html>
<head>
  <title>Hyperliquid Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0d1117; color: #e6edf3; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; }
    h1 { margin-bottom: 20px; font-size: 28px; }
    .tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid #30363d; }
    .tab { padding: 12px 24px; cursor: pointer; color: #8b949e; border-bottom: 2px solid transparent; transition: all 0.2s; font-size: 16px; }
    .tab:hover { color: #e6edf3; }
    .tab.active { color: #e6edf3; border-bottom: 2px solid #3fb950; }
    .year-tabs { display: flex; gap: 8px; margin-bottom: 25px; }
    .year-tab { padding: 8px 20px; cursor: pointer; color: #8b949e; background: #161b22; border-radius: 6px; transition: all 0.2s; font-size: 14px; font-weight: 500; }
    .year-tab:hover { color: #e6edf3; background: #21262d; }
    .year-tab.active { color: #e6edf3; background: #238636; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .month { margin-bottom: 40px; }
    .month-header { font-size: 22px; margin-bottom: 15px; display: flex; gap: 15px; align-items: baseline; flex-wrap: wrap; }
    .month-name { color: #e6edf3; }
    .month-total { font-weight: bold; }
    .month-total.positive { color: #3fb950; }
    .month-total.negative { color: #f85149; }
    .month-info { color: #8b949e; font-size: 14px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .day-header { text-align: center; padding: 8px; color: #8b949e; font-size: 12px; }
    .day { background: #161b22; border-radius: 6px; padding: 10px; min-height: 70px; position: relative; }
    .day.empty { background: transparent; }
    .day.clickable { cursor: pointer; transition: background 0.2s; }
    .day.clickable:hover { background: #21262d; }
    .day.has-note { border-left: 3px solid #f0883e; }
    .day-number { font-size: 11px; color: #8b949e; margin-bottom: 5px; }
    .day-amount { font-size: 14px; font-weight: 600; }
    .day-amount.positive { color: #3fb950; }
    .day-amount.negative { color: #f85149; }
    .day-trades { font-size: 10px; color: #8b949e; margin-top: 3px; }
    .note-indicator { position: absolute; top: 6px; right: 6px; font-size: 10px; }
    .loading { text-align: center; padding: 50px; color: #8b949e; }
    .summary { background: #161b22; border-radius: 8px; padding: 20px; margin-bottom: 25px; display: flex; gap: 40px; flex-wrap: wrap; }
    .summary-label { color: #8b949e; font-size: 14px; }
    .summary-value { font-size: 28px; font-weight: bold; }
    .summary-value.positive { color: #3fb950; }
    .summary-value.negative { color: #f85149; }
    .year-summary { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 16px 20px; margin-bottom: 25px; display: flex; gap: 30px; flex-wrap: wrap; }
    .year-summary-label { color: #8b949e; font-size: 12px; }
    .year-summary-value { font-size: 22px; font-weight: bold; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: #161b22; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 85vh; overflow-y: auto; border: 1px solid #30363d; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #30363d; }
    .modal-title { font-size: 20px; font-weight: 600; }
    .modal-close { cursor: pointer; font-size: 24px; color: #8b949e; background: none; border: none; }
    .modal-close:hover { color: #e6edf3; }
    .modal-summary { display: flex; gap: 30px; margin-bottom: 20px; padding: 15px; background: #0d1117; border-radius: 8px; flex-wrap: wrap; }
    .modal-summary-label { font-size: 12px; color: #8b949e; }
    .modal-summary-value { font-size: 20px; font-weight: 600; }
    .trades-table { width: 100%; border-collapse: collapse; }
    .trades-table th { text-align: left; padding: 10px 8px; color: #8b949e; font-weight: 500; font-size: 12px; border-bottom: 1px solid #30363d; }
    .trades-table td { padding: 10px 8px; font-size: 13px; border-bottom: 1px solid #21262d; }
    .trades-table tr:hover { background: #21262d; }
    .trade-coin { font-weight: 600; }
    .trade-side { font-size: 11px; padding: 2px 6px; border-radius: 4px; }
    .trade-side.long { background: #238636; color: #fff; }
    .trade-side.short { background: #da3633; color: #fff; }
    .trade-pnl.positive { color: #3fb950; }
    .trade-pnl.negative { color: #f85149; }
    .no-data { text-align: center; padding: 40px; color: #8b949e; }
    .journal-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #30363d; }
    .journal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .journal-title { font-size: 16px; font-weight: 600; color: #f0883e; }
    .journal-textarea { width: 100%; min-height: 150px; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 12px; color: #e6edf3; font-family: inherit; font-size: 14px; line-height: 1.6; resize: vertical; }
    .journal-textarea:focus { outline: none; border-color: #f0883e; }
    .journal-textarea::placeholder { color: #6e7681; }
    .journal-actions { display: flex; gap: 10px; margin-top: 12px; align-items: center; }
    .journal-btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .journal-btn-save { background: #238636; border: none; color: #fff; }
    .journal-btn-save:hover { background: #2ea043; }
    .journal-btn-delete { background: transparent; border: 1px solid #f85149; color: #f85149; }
    .journal-btn-delete:hover { background: #f85149; color: #fff; }
    .journal-saved { color: #3fb950; font-size: 13px; opacity: 0; transition: opacity 0.3s; }
    .journal-saved.show { opacity: 1; }
    .journal-display { background: #0d1117; border-radius: 8px; padding: 15px; line-height: 1.7; white-space: pre-wrap; font-size: 14px; }
    .journal-edit-btn { background: transparent; border: 1px solid #30363d; color: #8b949e; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; }
    .journal-edit-btn:hover { border-color: #f0883e; color: #f0883e; }
    .journal-controls { display: flex; gap: 10px; }
    .journal-ctrl-btn { background: #21262d; border: 1px solid #30363d; color: #e6edf3; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .journal-ctrl-btn:hover { background: #30363d; border-color: #f0883e; }
  </style>
</head>
<body>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h1 style="margin:0;">Hyperliquid Dashboard</h1>
    <div class="journal-controls">
      <button class="journal-ctrl-btn" onclick="exportJournal()" title="Download backup of all journal entries">Export Journal</button>
      <button class="journal-ctrl-btn" onclick="document.getElementById('import-file').click()" title="Restore journal from backup file">Import Journal</button>
      <button class="journal-ctrl-btn" onclick="clearJournal()" title="Clear all journal entries (for testing)" style="color:#f85149;">Clear All</button>
      <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJournal(event)">
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="funding">Funding</div>
    <div class="tab" data-tab="pnl">Realized P&L</div>
    <div class="tab" data-tab="combined">Combined</div>
  </div>

  <div id="funding" class="tab-content active"><div class="loading">Loading funding data...</div></div>
  <div id="pnl" class="tab-content"><div class="loading">Loading P&L data...</div></div>
  <div id="combined" class="tab-content"><div class="loading">Loading combined data...</div></div>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Trade Details</div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
    const WALLET = '0x3093189bd4d429CB2F47D03C14b9e9200B6b9425';
    const API_URL = 'https://api.hyperliquid.xyz/info';
    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    let allFills = [];
    let allFunding = [];
    let currentTab = 'funding';
    let currentYears = { funding: null, pnl: null, combined: null };
    let currentModalDate = null;
    let isEditingNote = false;

    // Journal/Notes functions using localStorage
    function getNote(date) {
      const notes = JSON.parse(localStorage.getItem('hl-journal') || '{}');
      return notes[date] || '';
    }

    function saveNote(date, text) {
      const notes = JSON.parse(localStorage.getItem('hl-journal') || '{}');
      if (text.trim()) {
        notes[date] = text;
      } else {
        delete notes[date];
      }
      localStorage.setItem('hl-journal', JSON.stringify(notes));
    }

    function hasNote(date) {
      const notes = JSON.parse(localStorage.getItem('hl-journal') || '{}');
      return !!notes[date];
    }

    function getAllNoteDates() {
      const notes = JSON.parse(localStorage.getItem('hl-journal') || '{}');
      return Object.keys(notes);
    }

    function exportJournal() {
      const notes = JSON.parse(localStorage.getItem('hl-journal') || '{}');
      const noteCount = Object.keys(notes).length;
      if (noteCount === 0) {
        alert('No journal entries to export.');
        return;
      }
      const data = {
        exportDate: new Date().toISOString(),
        noteCount: noteCount,
        entries: notes
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'trading-journal-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('Journal exported! ' + noteCount + ' entries saved.');
    }

    function importJournal(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          const entries = data.entries || data;
          const existingNotes = JSON.parse(localStorage.getItem('hl-journal') || '{}');
          const existingCount = Object.keys(existingNotes).length;
          const importCount = Object.keys(entries).length;

          // Merge: imported entries will overwrite existing ones for same dates
          const merged = { ...existingNotes, ...entries };
          localStorage.setItem('hl-journal', JSON.stringify(merged));

          const newCount = Object.keys(merged).length;
          alert('Journal imported! ' + importCount + ' entries loaded. Total entries: ' + newCount);
          refreshCalendars();
        } catch (err) {
          alert('Error importing journal: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = ''; // Reset file input
    }

    function clearJournal() {
      const notes = JSON.parse(localStorage.getItem('hl-journal') || '{}');
      const count = Object.keys(notes).length;
      if (count === 0) {
        alert('Journal is already empty.');
        return;
      }
      if (confirm('Delete all ' + count + ' journal entries? Make sure you have a backup!')) {
        localStorage.removeItem('hl-journal');
        alert('Journal cleared.');
        refreshCalendars();
      }
    }

    // Pre-populate example note for demo
    (function initExampleNote() {
      const notes = JSON.parse(localStorage.getItem('hl-journal') || '{}');
      if (!notes['2026-01-09']) {
        notes['2026-01-09'] = `Ok so last night I managed to take another 0.5BTC off the table as BTC grinded down to 89,500. It trended back up and is now trading around 91.3k. ETH also bounced from the low (missed my limit order to take profit by $4, but it is what it is).

As of now, I think the bounce is due to shorts getting liquidated hence the bounce was violent imo. Trend is still down I feel, no bullish factors, no marginal buyers left to buy, hence will still continue grinding down.

All my tweeter posts that I follow is calling for 75-85k levels for BTC, but since everyone is calling for this level I highly doubt it will get there. Maybe touching the previous low 86k would be good enough for me.

Right now both BTC and ETH has touched the lower high, and if I am right it should bounce up and then eventually go down.`;
        localStorage.setItem('hl-journal', JSON.stringify(notes));
      }
    })();

    // Main tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        document.getElementById(currentTab).classList.add('active');
      });
    });

    function formatUSD(amount) {
      const sign = amount >= 0 ? '+' : '';
      if (Math.abs(amount) >= 1000) return sign + '$' + (amount / 1000).toFixed(2) + 'K';
      return sign + '$' + amount.toFixed(0);
    }

    function formatUSDFull(amount) {
      const sign = amount >= 0 ? '+' : '';
      return sign + '$' + Math.abs(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    async function fetchFunding() {
      // Fetch last 90 days of funding
      const startTime = Date.now() - (90 * 24 * 60 * 60 * 1000);
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'userFunding', user: WALLET, startTime: startTime })
      });
      return res.json();
    }

    async function fetchFills() {
      // Fetch fills - the API returns up to 2000 recent fills
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'userFills', user: WALLET })
      });
      return res.json();
    }

    function groupFundingByDay(data) {
      const byDay = {};
      data.forEach(f => {
        const date = new Date(f.time).toISOString().split('T')[0];
        byDay[date] = (byDay[date] || 0) + parseFloat(f.delta.usdc);
      });
      return byDay;
    }

    function groupFillsByDay(fills) {
      const byDay = {};
      fills.forEach(f => {
        if (!f.closedPnl || parseFloat(f.closedPnl) === 0) return;
        const date = new Date(f.time).toISOString().split('T')[0];
        if (!byDay[date]) byDay[date] = { pnl: 0, trades: 0 };
        byDay[date].pnl += parseFloat(f.closedPnl);
        byDay[date].trades += 1;
      });
      return byDay;
    }

    function groupByYearAndMonth(byDay, isPnl) {
      const years = {};
      Object.entries(byDay).forEach(([date, data]) => {
        const year = date.substring(0, 4);
        const month = date.substring(0, 7);
        if (!years[year]) years[year] = { total: 0, trades: 0, months: {} };
        if (!years[year].months[month]) years[year].months[month] = { total: 0, trades: 0, days: {} };

        if (isPnl) {
          years[year].total += data.pnl;
          years[year].trades += data.trades;
          years[year].months[month].total += data.pnl;
          years[year].months[month].trades += data.trades;
          years[year].months[month].days[date] = data;
        } else {
          years[year].total += data;
          years[year].months[month].total += data;
          years[year].months[month].days[date] = { amount: data };
        }
      });
      return years;
    }

    function renderJournalSection(date) {
      const note = getNote(date);
      let html = '<div class="journal-section">';
      html += '<div class="journal-header"><span class="journal-title">Trading Journal</span>';
      if (note && !isEditingNote) {
        html += '<button class="journal-edit-btn" onclick="startEditNote()">Edit</button>';
      }
      html += '</div>';

      if (!note || isEditingNote) {
        html += '<textarea class="journal-textarea" id="journal-input" placeholder="Write your thoughts about today\'s trades...">' + (note || '') + '</textarea>';
        html += '<div class="journal-actions">';
        html += '<button class="journal-btn journal-btn-save" onclick="saveJournalNote()">Save Note</button>';
        if (note) {
          html += '<button class="journal-btn journal-btn-delete" onclick="deleteJournalNote()">Delete</button>';
        }
        html += '<span class="journal-saved" id="journal-saved">Saved!</span>';
        html += '</div>';
      } else {
        html += '<div class="journal-display">' + escapeHtml(note) + '</div>';
      }

      html += '</div>';
      return html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function startEditNote() {
      isEditingNote = true;
      refreshModal();
    }

    function saveJournalNote() {
      const input = document.getElementById('journal-input');
      if (input && currentModalDate) {
        saveNote(currentModalDate, input.value);
        isEditingNote = false;
        refreshModal();
        refreshCalendars();
        // Show saved indicator
        setTimeout(() => {
          const saved = document.getElementById('journal-saved');
          if (saved) {
            saved.classList.add('show');
            setTimeout(() => saved.classList.remove('show'), 2000);
          }
        }, 100);
      }
    }

    function deleteJournalNote() {
      if (currentModalDate && confirm('Delete this journal entry?')) {
        saveNote(currentModalDate, '');
        isEditingNote = false;
        refreshModal();
        refreshCalendars();
      }
    }

    function refreshModal() {
      if (currentModalDate) {
        if (currentTab === 'pnl') {
          showTradeDetails(currentModalDate);
        } else {
          showFundingDetails(currentModalDate);
        }
      }
    }

    function refreshCalendars() {
      renderYearContent(fundingYears, 'funding', false, false, currentYears['funding']);
      renderYearContent(pnlYears, 'pnl', true, false, currentYears['pnl']);
      renderYearContent(combinedYears, 'combined', true, true, currentYears['combined']);
    }

    function showTradeDetails(date) {
      currentModalDate = date;
      if (!isEditingNote) isEditingNote = false;

      const dateStart = new Date(date + 'T00:00:00Z').getTime();
      const dateEnd = new Date(date + 'T23:59:59Z').getTime();
      const dayTrades = allFills.filter(f => f.time >= dateStart && f.time <= dateEnd && f.closedPnl && parseFloat(f.closedPnl) !== 0).sort((a, b) => b.time - a.time);
      const totalPnl = dayTrades.reduce((sum, t) => sum + parseFloat(t.closedPnl), 0);
      const totalFees = dayTrades.reduce((sum, t) => sum + parseFloat(t.fee || 0), 0);
      const dateFormatted = new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      document.getElementById('modal-title').textContent = dateFormatted;
      let html = '<div class="modal-summary">';
      html += '<div class="modal-summary-item"><div class="modal-summary-label">Realized P&L</div><div class="modal-summary-value ' + (totalPnl >= 0 ? 'positive' : 'negative') + '">' + formatUSDFull(totalPnl) + '</div></div>';
      html += '<div class="modal-summary-item"><div class="modal-summary-label">Trades</div><div class="modal-summary-value">' + dayTrades.length + '</div></div>';
      html += '<div class="modal-summary-item"><div class="modal-summary-label">Fees</div><div class="modal-summary-value negative">-$' + totalFees.toFixed(2) + '</div></div>';
      html += '</div>';

      if (dayTrades.length > 0) {
        html += '<table class="trades-table"><thead><tr><th>Time</th><th>Coin</th><th>Side</th><th>Size</th><th>Price</th><th>P&L</th></tr></thead><tbody>';
        dayTrades.forEach(t => {
          const pnl = parseFloat(t.closedPnl);
          const pnlClass = pnl >= 0 ? 'positive' : 'negative';
          const sideClass = t.dir.toLowerCase().includes('short') ? 'short' : 'long';
          html += '<tr><td>' + formatTime(t.time) + '</td><td class="trade-coin">' + t.coin + '</td><td><span class="trade-side ' + sideClass + '">' + t.dir + '</span></td><td>' + parseFloat(t.sz).toFixed(4) + '</td><td>$' + parseFloat(t.px).toLocaleString() + '</td><td class="trade-pnl ' + pnlClass + '">' + formatUSDFull(pnl) + '</td></tr>';
        });
        html += '</tbody></table>';
      }

      html += renderJournalSection(date);

      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('modal').classList.add('active');
    }

    function showFundingDetails(date) {
      currentModalDate = date;
      if (!isEditingNote) isEditingNote = false;

      const dateStart = new Date(date + 'T00:00:00Z').getTime();
      const dateEnd = new Date(date + 'T23:59:59Z').getTime();
      const dayFunding = allFunding.filter(f => f.time >= dateStart && f.time <= dateEnd);
      const totalFunding = dayFunding.reduce((sum, f) => sum + parseFloat(f.delta.usdc), 0);
      const byCoin = {};
      dayFunding.forEach(f => { byCoin[f.delta.coin] = (byCoin[f.delta.coin] || 0) + parseFloat(f.delta.usdc); });
      const dateFormatted = new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      document.getElementById('modal-title').textContent = dateFormatted + ' - Funding';
      let html = '<div class="modal-summary">';
      html += '<div class="modal-summary-item"><div class="modal-summary-label">Total Funding</div><div class="modal-summary-value ' + (totalFunding >= 0 ? 'positive' : 'negative') + '">' + formatUSDFull(totalFunding) + '</div></div>';
      html += '<div class="modal-summary-item"><div class="modal-summary-label">Payments</div><div class="modal-summary-value">' + dayFunding.length + '</div></div>';
      html += '</div>';
      html += '<h3 style="margin-bottom:10px;font-size:14px;color:#8b949e;">By Coin</h3>';
      html += '<table class="trades-table"><thead><tr><th>Coin</th><th>Funding</th></tr></thead><tbody>';
      Object.entries(byCoin).sort((a,b) => Math.abs(b[1]) - Math.abs(a[1])).forEach(([coin, amt]) => {
        html += '<tr><td class="trade-coin">' + coin + '</td><td class="trade-pnl ' + (amt >= 0 ? 'positive' : 'negative') + '">' + formatUSDFull(amt) + '</td></tr>';
      });
      html += '</tbody></table>';

      html += renderJournalSection(date);

      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      isEditingNote = false;
      currentModalDate = null;
    }
    document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    function renderYearContent(years, containerId, isPnl, isCombined, selectedYear) {
      const container = document.getElementById(containerId);
      const sortedYears = Object.keys(years).sort().reverse();

      if (sortedYears.length === 0) {
        container.innerHTML = '<div class="no-data">No data available</div>';
        return;
      }

      if (!selectedYear || !years[selectedYear]) {
        selectedYear = sortedYears[0];
      }
      currentYears[containerId] = selectedYear;

      let allTimeTotal = 0, allTimeTrades = 0;
      Object.values(years).forEach(y => {
        allTimeTotal += y.total;
        allTimeTrades += y.trades || 0;
      });
      const allTimeClass = allTimeTotal >= 0 ? 'positive' : 'negative';

      let html = '';

      html += '<div class="summary">';
      html += '<div class="summary-item"><div class="summary-label">' + (isCombined ? 'Total (Funding + P&L)' : isPnl ? 'Realized P&L' : 'Funding') + ' (All Time)</div>';
      html += '<div class="summary-value ' + allTimeClass + '">' + formatUSDFull(allTimeTotal) + '</div></div>';
      if (isPnl || isCombined) {
        html += '<div class="summary-item"><div class="summary-label">Total Trades</div>';
        html += '<div class="summary-value" style="color:#e6edf3">' + allTimeTrades + '</div></div>';
      }
      html += '</div>';

      html += '<div class="year-tabs">';
      sortedYears.forEach(year => {
        const isActive = year === selectedYear ? ' active' : '';
        html += '<div class="year-tab' + isActive + '" onclick="selectYear(\'' + containerId + '\', \'' + year + '\', ' + isPnl + ', ' + isCombined + ')">' + year + '</div>';
      });
      html += '</div>';

      const yearData = years[selectedYear];
      const yearClass = yearData.total >= 0 ? 'positive' : 'negative';
      html += '<div class="year-summary">';
      html += '<div class="year-summary-item"><div class="year-summary-label">' + selectedYear + ' Total</div>';
      html += '<div class="year-summary-value ' + yearClass + '">' + formatUSDFull(yearData.total) + '</div></div>';
      if (yearData.trades) {
        html += '<div class="year-summary-item"><div class="year-summary-label">Trades</div>';
        html += '<div class="year-summary-value" style="color:#e6edf3">' + yearData.trades + '</div></div>';
      }
      html += '</div>';

      const sortedMonths = Object.keys(yearData.months).sort().reverse();

      sortedMonths.forEach(monthKey => {
        const month = yearData.months[monthKey];
        const [year, monthNum] = monthKey.split('-');
        const monthName = new Date(year, monthNum - 1).toLocaleString('en-US', { month: 'long' });
        const mTotalClass = month.total >= 0 ? 'positive' : 'negative';

        html += '<div class="month"><div class="month-header"><span class="month-name">' + monthName + ':</span><span class="month-total ' + mTotalClass + '">' + formatUSDFull(month.total) + '</span>';
        if (month.trades) html += '<span class="month-info">(' + month.trades + ' trades)</span>';
        html += '</div><div class="calendar-grid">';
        dayNames.forEach(d => html += '<div class="day-header">' + d + '</div>');

        const firstDay = new Date(year, monthNum - 1, 1);
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        let startDay = firstDay.getDay();
        startDay = startDay === 0 ? 6 : startDay - 1;
        for (let i = 0; i < startDay; i++) html += '<div class="day empty"></div>';

        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = monthKey + '-' + String(d).padStart(2, '0');
          const dayData = month.days[dateStr];
          const amount = dayData ? (isPnl || isCombined ? dayData.pnl : dayData.amount) : 0;
          const hasData = amount !== 0;
          const hasNoteForDay = hasNote(dateStr);
          const isClickable = hasData || hasNoteForDay;
          const clickFn = isPnl && !isCombined ? 'showTradeDetails' : 'showFundingDetails';

          const noteClass = hasNoteForDay ? ' has-note' : '';
          html += '<div class="day' + noteClass + (isClickable ? ' clickable" onclick="' + clickFn + '(\'' + dateStr + '\')"' : '"') + '>';
          html += '<div class="day-number">' + d + '</div>';
          if (hasNoteForDay) html += '<span class="note-indicator">üìù</span>';
          if (hasData) {
            html += '<div class="day-amount ' + (amount >= 0 ? 'positive' : 'negative') + '">' + formatUSD(amount) + '</div>';
            if (dayData.trades) html += '<div class="day-trades">' + dayData.trades + ' trade' + (dayData.trades > 1 ? 's' : '') + '</div>';
          }
          html += '</div>';
        }
        html += '</div></div>';
      });

      if (isPnl && !isCombined) html += '<p style="color:#8b949e;font-size:12px;margin-top:20px;">Click on any day to see trade details. Days with üìù have journal entries.</p>';
      container.innerHTML = html;
    }

    let fundingYears = {};
    let pnlYears = {};
    let combinedYears = {};

    function selectYear(containerId, year, isPnl, isCombined) {
      let years;
      if (containerId === 'funding') years = fundingYears;
      else if (containerId === 'pnl') years = pnlYears;
      else years = combinedYears;

      renderYearContent(years, containerId, isPnl, isCombined, year);
    }

    async function init() {
      try {
        const [fundingData, fillsData] = await Promise.all([fetchFunding(), fetchFills()]);
        allFunding = fundingData;
        allFills = fillsData;

        const fundingByDay = groupFundingByDay(fundingData);
        fundingYears = groupByYearAndMonth(fundingByDay, false);
        renderYearContent(fundingYears, 'funding', false, false, null);

        const pnlByDay = groupFillsByDay(fillsData);
        pnlYears = groupByYearAndMonth(pnlByDay, true);
        renderYearContent(pnlYears, 'pnl', true, false, null);

        const combinedByDay = {};
        Object.entries(fundingByDay).forEach(([date, amt]) => {
          if (!combinedByDay[date]) combinedByDay[date] = { pnl: 0, trades: 0 };
          combinedByDay[date].pnl += amt;
        });
        Object.entries(pnlByDay).forEach(([date, data]) => {
          if (!combinedByDay[date]) combinedByDay[date] = { pnl: 0, trades: 0 };
          combinedByDay[date].pnl += data.pnl;
          combinedByDay[date].trades += data.trades;
        });
        combinedYears = groupByYearAndMonth(combinedByDay, true);
        renderYearContent(combinedYears, 'combined', true, true, null);
      } catch (err) {
        document.querySelectorAll('.tab-content').forEach(c => { c.innerHTML = '<div class="loading">Error: ' + err.message + '</div>'; });
      }
    }

    init();
  </script>
</body>
</html>
